# Caddy reverse proxy configuration for TrustLink Backend
# Serves on both HTTP and HTTPS with automatic self-signed certificates for IP access

:80, :443 {
    # Caddy health check endpoint
    handle /health {
        respond "Caddy OK" 200
    }

    # Main reverse proxy to gateway service
    reverse_proxy gateway:8080 {
        # Preserve original request information
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # Health check for upstream
        health_uri /healthz
        health_interval 30s
        health_timeout 10s
    }

    # CORS headers for Flutter app (all origins allowed for development)
    header {
        # Allow requests from any origin (Flutter apps)
        Access-Control-Allow-Origin *
        
        # Allow common HTTP methods
        Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        
        # Allow Authorization header (for Firebase tokens)
        Access-Control-Allow-Headers "Authorization, Content-Type, Accept"
        
        # Cache preflight requests for 1 hour
        Access-Control-Max-Age "3600"
        
        # Security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Remove server header for security
        -Server
    }

    # Handle OPTIONS preflight requests
    @options {
        method OPTIONS
    }
    handle @options {
        respond 204
    }

    # Structured logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
        level INFO
    }

    # Error handling
    handle_errors {
        respond "{\"error\": {\"code\": \"server_error\", \"message\": \"An error occurred\"}}" 500
    }
}
